<!DOCTYPE html>
<html>
    <head>
        <title>LAZER TAG</title>
        <meta charset="utf-8" />
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <script https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
        <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    </head>

    <body>
        <a-scene player-pos background="color:rgb(0, 0, 0);">
            <a-assets timeout="20000">
                <!--Loading all A-frame Assets-->
                
                <!--Audio assets-->
                <!--https://freetouse.com/music/lukrembo/marshmallow-->
                <audio id="backgroundMusic" src="audio/backgroundMusic.mp3" preload="auto" crossorigin="anonymous"></audio>
                <!--https://pixabay.com/sound-effects/bell-98033/-->
                <audio id="laser1Sound" src="audio/laser1Sound.mp3" preload="auto" crossorigin="anonymous"></audio>
                <!--https://pixabay.com/sound-effects/cooking-frying-1-71871/-->
                <audio id="laser2Sound" src="audio/laster2Sound.mp3" preload="auto" crossorigin="anonymous"></audio>
                <!--https://pixabay.com/sound-effects/plop-sound-made-with-my-mouth-100690/-->
                <audio id="loserSound" src="audio/loserSound.mp3" preload="auto" crossorigin="anonymous"></audio>
                <!--https://pixabay.com/sound-effects/plop-sound-made-with-my-mouth-100690/-->
                <audio id="victorySound" src="audio/victorySound.mp3" preload="auto" crossorigin="anonymous"></audio>
                <!--https://pixabay.com/sound-effects/plop-sound-made-with-my-mouth-100690/-->
                <audio id="teleportSound" src="audio/teleportSound.mp3" preload="auto" crossorigin="anonymous"></audio>

            </a-assets>
            <a-entity   id="player1" 
                        look-controls camera wasd-controls="acceleration: 25" 
                        position="0 1.6 0">
                <a-entity   cursor raycaster="far:20; objects:.interactive" 
                            position="0 0 -0.1"
                            geometry="primitive: ring; radiusInner: 0.0004; radiusOuter: 0.001"
                            material="color: white; shader: standard; emissive: rgb(255, 255, 255);"></a-entity>
            </a-entity>
            <a-entity   id="HitBoxPlayer1" 
                        position="0 1.7 0">
                <a-entity   id="headBox1"
                            class="button interactive"
                            geometry="primitive:box; width:0.5; depth:0.5; height:0.6;"
                            material="color: rgb(0, 187, 187); shader: standard; emissive: rgb(0, 187, 187);"
                            visible="true">
                </a-entity>
                <a-entity   id="bodyBox1"
                            class="button interactive"
                            position="0 -0.8 0" 
                            geometry="primitive:box; width:0.5; depth:0.5; height:0.8;"
                            material="color: rgb(0, 187, 187);shader: standard; emissive: rgb(0, 187, 187);"
                            visible="true">
                </a-entity>
                <a-entity   id="laserFireTeal"
                            position="0 -0.4 -10" 
                            rotation="90 0 0"
                            geometry="primitive: cylinder; height: 20; radius: 0.02;"
                            material="color: rgb(0, 187, 187);shader: standard; emissive: rgb(0, 187, 187);"
                            visible="false">
                </a-entity>
                <a-entity   id="tealHitConfirm"
                            position="0 -0.4 0" 
                            geometry="primitive: cylinder; openEnded: true; height: 2.5;" 
                            material="color: red; side: double; emissive: rgb(255, 0, 0); opacity: 0.5;"
                            visible="false">
                </a-entity>
            </a-entity>

            <a-entity id="player2" look-controls camera wasd-controls="acceleration: 25" position="0 1.6 0">
                <a-entity   cursor raycaster="far:20; objects:.interactive" 
                            position="0 0 -0.1"
                            geometry="primitive: ring; radiusInner: 0.0004; radiusOuter: 0.001"
                            material="color: white; shader: standard; emissive: rgb(255, 255, 255)">
                </a-entity>
            </a-entity>
            <a-entity id="HitBoxPlayer2" position="0 1.7 0">
                <a-entity   id="headBox2"
                            class="button interactive"            
                            geometry="primitive:box; width:0.5; depth:0.5; height:0.6;"
                            material="color: rgb(227, 11, 92); shader: standard; emissive: rgb(227, 11, 92);">

                </a-entity>
                <a-entity   id="bodyBox2"
                            class="button interactive"
                            position="0 -0.8 0" 
                            geometry="primitive:box; width:0.5; depth:0.5; height:0.8;"
                            material="color: rgb(255, 11, 92); shader: standard; emissive: rgb(227, 11, 92);">
                </a-entity>
                <a-entity   id="laserFirePink"
                            position="0 -0.4 -10" 
                            rotation="90 0 0"
                            geometry="primitive: cylinder; height: 20; radius: 0.02;"
                            material="color: rgb(0, 187, 187);shader: standard; emissive: rgb(227, 11, 92);"
                            visible="false">
                </a-entity>
                <a-entity   id="pinkHitConfirm"
                            position="0 -0.4 0" 
                            geometry="primitive: cylinder; openEnded: true; height: 2.5;" 
                            material="color: red; side: double; emissive: rgb(255, 0, 0); opacity: 0.5;"
                            visible="false">
                </a-entity>
            </a-entity>

            <a-entity   id="Environment;"
                environment="preset:starry;">
            </a-entity>

        </a-scene>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            var laser1Sound = new Audio('audio/laser1Sound.mp3');
            var laser2Sound = new Audio('audio/laster2Sound.mp3');
            var loserSound = new Audio('audio/loserSound.mp3');
            var victorySound = new Audio('audio/victorySound.mp3');
            var teleportSound = new Audio('audio/teleportSound.mp3');


            const socket = io();

            socket.on('connect', (userData) => {
                console.log('I exist!');
                console.log(socket.id);
                socket.emit('hide_player1');

                socket.on('hide_play1', (data) => {
                console.log("hiding");
                document.querySelector('#headBox1').setAttribute('visible', 'false');
                document.querySelector('#bodyBox1').setAttribute('visible', 'false');
            });

                //put code here so that we know that socket.io has initailized ...
                document.querySelector('#headBox1').addEventListener('click', function(){
                    console.log("player 1 hit");
                    socket.emit('tealHit');
                });
                document.querySelector('#bodyBox1').addEventListener('click', function(){
                    console.log("player 1 hit");
                    socket.emit('tealHit');
                });

                document.querySelector('#headBox2').addEventListener('click', function(){
                    console.log("player 2 hit");    
                    socket.emit('pinkHit');
                    loserSound.play();  
                });
                document.querySelector('#bodyBox2').addEventListener('click', function(){
                    console.log("player 2 hit");   
                    socket.emit('pinkHit');
                    loserSound.play(); 
                });
                
                document.addEventListener('mousedown', function(){
                    console.log("shooting");
                    socket.emit('shooting');
                });

                
                socket.on('player1_shooting', (data) => {
                    if(data.id === "playerOne"){
                        console.log("teal shooting");
                        document.querySelector('#laserFireTeal').setAttribute('visible', 'true');
                        laser1Sound.play();
                        setTimeout(() => document.querySelector('#laserFireTeal').setAttribute('visible', 'false'), 20);
                    };
                });
                socket.on('player2_shooting', (data) => {
                    if(data.id === "playerTwo"){
                        console.log("pink shooting");
                        document.querySelector('#laserFirePink').setAttribute('visible', 'true');
                        laser2Sound.play();
                        setTimeout(() => document.querySelector('#laserFirePink').setAttribute('visible', 'false'), 20);
                    };
                });
            });

            AFRAME.registerComponent('player-pos', {
                tick: function () {
                    let xPosPlayer1 = document.querySelector("#player1").getAttribute('position').x;
                    let yPosPlayer1 = document.querySelector("#player1").getAttribute('position').y;
                    let zPosPlayer1 = document.querySelector("#player1").getAttribute('position').z;

                    let xRotPlayer1 = document.querySelector("#player1").getAttribute('rotation').x;
                    let yRotPlayer1 = document.querySelector("#player1").getAttribute('rotation').y;
                    let zRotPlayer1 = document.querySelector("#player1").getAttribute('rotation').z;

                    socket.emit('player1Pos', {xPos:xPosPlayer1, yPos:yPosPlayer1, zPos:zPosPlayer1, xRot:xRotPlayer1, yRot:yRotPlayer1, zRot:zRotPlayer1});

                    let xPosPlayer2 = document.querySelector("#player2").getAttribute('position').x;
                    let yPosPlayer2 = document.querySelector("#player2").getAttribute('position').y;
                    let zPosPlayer2 = document.querySelector("#player2").getAttribute('position').z;

                    let xRotPlayer2 = document.querySelector("#player2").getAttribute('rotation').x;
                    let yRotPlayer2 = document.querySelector("#player2").getAttribute('rotation').y;
                    let zRotPlayer2 = document.querySelector("#player2").getAttribute('rotation').z;

                    socket.emit('player2Pos', {xPos:xPosPlayer2, yPos:yPosPlayer2, zPos:zPosPlayer2, xRot:xRotPlayer2, yRot:yRotPlayer2, zRot:zRotPlayer2});
                }
            });

            socket.on('player1_update', (data) => {
                let player1Position = data.xPos + ' ' + data.yPos + ' ' + data.zPos;
                let player1Rotation = data.xRot + ' ' + data.yRot + ' ' + data.zRot;

                //document.body.style.backgroundColor = colorStr;
                document.querySelector('#HitBoxPlayer1').setAttribute('position', player1Position);
                document.querySelector('#HitBoxPlayer1').setAttribute('rotation', player1Rotation);
            });

            socket.on('player2_update', (data) => {

                let player2Position = data.xPos + ' ' + data.yPos + ' ' + data.zPos;
                let player2Rotation = data.xRot + ' ' + data.yRot + ' ' + data.zRot;

                document.querySelector('#HitBoxPlayer2').setAttribute('position', player2Position);
                document.querySelector('#HitBoxPlayer2').setAttribute('rotation', player2Rotation);
            });

            socket.on('teal_wins', (data) => {
                document.querySelector('#pinkHitConfirm').setAttribute('visible', 'true');
                victorySound.play();
                //alert("Player One Wins (Teal)");
            });
            socket.on('pink_wins', (data) => {
                document.querySelector('#tealHitConfirm').setAttribute('visible', 'true');
                victorySound.play();
                //alert("Player Two Wins (Pink)");
            });

        </script>
    </body>
</html>
